<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Analyse Intelligente - AutoRent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #0f172a;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #38bdf8;
    }
    .stat-boxes {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 40px;
    }
    .box {
      background: #1e293b;
      padding: 20px;
      border-radius: 12px;
      flex: 1 1 250px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .box h3 {
      color: #facc15;
      font-size: 1.2rem;
      margin-bottom: 10px;
    }
    .box p {
      font-size: 1.6rem;
      font-weight: bold;
      margin: 0;
    }
    .chart-container {
      max-width: 1000px;
      margin: 40px auto;
      background-color: #1e293b;
      padding: 20px;
      border-radius: 12px;
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
    }
    #loader {
      text-align: center;
      padding: 24px;
      color: #38bdf8;
      font-weight: 600;
      display: none;
    }
    .skeleton {
      background: linear-gradient(90deg, #1e293b 25%, #2d3748 50%, #1e293b 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      height: 20px;
      border-radius: 4px;
      margin: 4px 0;
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>

<h1>ðŸ“Š Analyse Intelligente des Performances</h1>

<div id="loader" aria-hidden="true">Chargement...</div>

<div class="stat-boxes">
  <div class="box">
    <h3>Chiffre d'affaires Total</h3>
    <p id="caTotal"><div class="skeleton"></div></p>
  </div>
  <div class="box">
    <h3>Total RÃ©servations</h3>
    <p id="totalRes"><div class="skeleton"></div></p>
  </div>
  <div class="box">
    <h3>Voiture la + rentable</h3>
    <p id="bestCar"><div class="skeleton"></div></p>
  </div>
  <div class="box">
    <h3>DisponibilitÃ© Moyenne</h3>
    <p id="dispo"><div class="skeleton"></div></p>
  </div>
</div>

<div class="chart-container">
  <h2>ðŸ’° Revenus vs DÃ©penses (6 derniers mois)</h2>
  <canvas id="chartFinance"></canvas>
</div>

<div class="chart-container">
  <h2>ðŸš— Performance par Voiture</h2>
  <canvas id="chartVoitures"></canvas>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
  import {
    getFirestore,
    collection,
    query,
    where,
    onSnapshot,
    getDocs,
    Timestamp
  } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
  import { firebaseConfig } from './js/firebase.js';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loader = document.getElementById("loader");
  let chartFinanceInstance = null;
  let chartVoituresInstance = null;
  let unsubscribeCars = null;

  function safeNumber(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  // retourne tableau mois (6 derniers mois format "janv. 2025" selon locale)
  function buildLast6Months(today = new Date()) {
    return Array.from({ length: 6 }, (_, i) => {
      const d = new Date(today.getFullYear(), today.getMonth() - (5 - i), 1);
      return d.toLocaleString('fr-FR', { month: 'short', year: 'numeric' });
    });
  }

  async function loadData(user) {
    loader.style.display = "block";

    const today = new Date();
    const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 5, 1);

    // 1) RÃ©cupÃ©rer toutes les rÃ©servations de l'agence (snapshot one-shot)
    const monthlyData = {}; // { "mai 2025": { ca: 0, depenses: 0 } }
    let totalReservations = 0;
    try {
      const resQuery = query(
        collection(db, "reservations"),
        where("agencyId", "==", user.uid)
      );
      const resSnapshot = await getDocs(resQuery);

      resSnapshot.forEach(doc => {
        const r = doc.data();
        // protÃ©ger contre valeurs manquantes / types invalides
        if (!r || !r.startDate || !r.totalPrice || !r.status) return;
        // n'agrÃ¨ge que les rÃ©servations confirmÃ©es dans les 6 derniers mois
        try {
          const start = (r.startDate instanceof Timestamp) ? r.startDate.toDate() : new Date(r.startDate);
          if (r.status === "confirmed" && start >= sixMonthsAgo) {
            const monthKey = start.toLocaleString('fr-FR', { month: 'short', year: 'numeric' });
            monthlyData[monthKey] = monthlyData[monthKey] || { ca: 0, depenses: 0 };
            monthlyData[monthKey].ca += safeNumber(r.totalPrice);
            totalReservations += 1;
          }
        } catch (e) {
          console.warn("RÃ©servation ignorÃ©e pour format de date inconnu:", e);
        }
      });
    } catch (err) {
      console.error("Erreur getDocs(reservations):", err);
      Toastify({ text: `Erreur: ${err.message}`, duration: 4000, backgroundColor: "#ef4444" }).showToast();
      loader.style.display = "none";
      return;
    }

    // 2) Ã‰coute temps rÃ©el des voitures (pour rÃ©activitÃ©)
    try {
      if (unsubscribeCars) unsubscribeCars(); // detach si exists

      const carsQuery = query(
        collection(db, "cars"),
        where("uid", "==", user.uid)
      );

      unsubscribeCars = onSnapshot(carsQuery, snapshot => {
        try {
          const voituresData = [];
          let totalCA = 0;
          let voituresDisponibles = 0;
          let totalVoitures = 0;
          let meilleureVoiture = { nom: '-', ca: 0 };

          snapshot.forEach(doc => {
            const v = doc.data();
            // sÃ©curiser le modÃ¨le attendu
            const nom = v.nom || 'Inconnu';
            const ca = safeNumber(v.ca);
            const dep = safeNumber(v.depenses);
            const dispo = !!v.disponible;

            voituresData.push({ nom, ca, dep });
            totalCA += ca;
            totalVoitures++;
            if (dispo) voituresDisponibles++;
            if (ca > meilleureVoiture.ca) meilleureVoiture = { nom, ca };
          });

          // Mettre Ã  jour l'UI
          document.getElementById("caTotal").textContent = `${totalCA.toFixed(2)} DH`;
          document.getElementById("totalRes").textContent = `${totalReservations}`;
          document.getElementById("bestCar").textContent = `${meilleureVoiture.nom}`;
          document.getElementById("dispo").textContent = totalVoitures > 0
            ? `${Math.round((voituresDisponibles / totalVoitures) * 100)}%`
            : "0%";

          // PrÃ©parer mois
          const mois = buildLast6Months(today);

          // PrÃ©parer donnÃ©es dÃ©penses par mois : on rÃ©partit (si tu veux) les dÃ©penses totales uniformÃ©ment, ici on met totalDepenses identique par mois (simple)
          const totalDepenses = voituresData.reduce((a, v) => a + v.dep, 0);

          // Chart Revenus vs DÃ©penses
          const caParMois = mois.map(m => safeNumber(monthlyData[m]?.ca));
          if (chartFinanceInstance) chartFinanceInstance.destroy();
          chartFinanceInstance = new Chart(document.getElementById('chartFinance'), {
            type: 'bar',
            data: {
              labels: mois,
              datasets: [
                { label: "Chiffre d'Affaire", data: caParMois, backgroundColor: '#4ade80' },
                { label: "DÃ©penses", data: mois.map(() => totalDepenses / 6), backgroundColor: '#f87171' } // ici on rÃ©partit uniformÃ©ment
              ]
            },
            options: {
              responsive: true,
              plugins: { legend: { labels: { color: '#fff' } } },
              scales: { x: { ticks: { color: '#fff' } }, y: { ticks: { color: '#fff' }, beginAtZero: true } }
            }
          });

          // Chart Performance par voiture
          if (chartVoituresInstance) chartVoituresInstance.destroy();
          chartVoituresInstance = new Chart(document.getElementById('chartVoitures'), {
            type: 'bar',
            data: {
              labels: voituresData.map(v => v.nom),
              datasets: [
                { label: 'CA', data: voituresData.map(v => v.ca), backgroundColor: '#22d3ee' },
                { label: 'DÃ©penses', data: voituresData.map(v => v.dep), backgroundColor: '#eab308' }
              ]
            },
            options: {
              responsive: true,
              plugins: { legend: { labels: { color: '#fff' } } },
              scales: { x: { ticks: { color: '#fff' } }, y: { ticks: { color: '#fff' }, beginAtZero: true } }
            }
          });

          loader.style.display = "none";
          Toastify({ text: "DonnÃ©es chargÃ©es avec succÃ¨s ðŸ“Š", duration: 3000, backgroundColor: "#4ade80" }).showToast();

        } catch (err) {
          console.error("Erreur onSnapshot(cars):", err);
          Toastify({ text: `Erreur: ${err.message}`, duration: 4000, backgroundColor: "#ef4444" }).showToast();
          loader.style.display = "none";
        }
      }, err => {
        console.error("Listener cars failed:", err);
        Toastify({ text: `Erreur listener voitures: ${err.message}`, duration: 4000, backgroundColor: "#ef4444" }).showToast();
        loader.style.display = "none";
      });

    } catch (err) {
      console.error("Erreur initialisation snapshot voitures:", err);
      Toastify({ text: `Erreur: ${err.message}`, duration: 4000, backgroundColor: "#ef4444" }).showToast();
      loader.style.display = "none";
    }
  }

  // Auth state
  onAuthStateChanged(auth, user => {
    if (!user) {
      if (unsubscribeCars) unsubscribeCars();
      window.location.href = "connexion.html";
      return;
    }
    loadData(user);
    // Note: rÃ¨gles Firestore cÃ´tÃ© serveur (security rules) obligatoires (voir plus bas).
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</body>
</html>
