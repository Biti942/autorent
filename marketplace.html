<!-- ✅ marketplace.html - version PRO améliorée avec fonctionnalités prioritaires -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AutoRent Marketplace - Location de voitures par modèle, ville et catégorie. Trouvez des berlines, SUVs, citadines à Casablanca, Rabat et plus.">
  <meta name="keywords" content="location voiture, marketplace auto, berline Casablanca, SUV Rabat, citadine Marrakech, utilitaire Tanger">
  <title>AutoRent - Marketplace</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/i18next@21.6.16/i18next.min.js"></script> <!-- Pour multilingue -->
  <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@1.4.0/i18nextHttpBackend.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: #f8fafc;
      color: #1e293b;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      position: sticky;
      top: 0;
      background: #0f172a;
      color: #fff;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
    }
    .logo {
      font-weight: 700;
      font-size: 1.8rem;
      cursor: pointer;
      user-select: none;
    }
    .auth-section {
      display: flex;
      align-items: center;
      gap: 16px;
      font-weight: 600;
    }
    .auth-section span {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .btn-auth {
      background: #3b82f6;
      color: #fff;
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    .btn-auth:hover {
      background: #2563eb;
    }
    .filters {
      max-width: 1000px;
      margin: 24px auto;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      align-items: end;
    }
    .filters label {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 6px;
      display: block;
    }
    .filters input, .filters select {
      width: 100%;
      padding: 10px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1e293b;
      outline-offset: 2px;
      outline-color: #3b82f6;
    }
    .filters button {
      background: #22c55e;
      color: #fff;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    .filters button:hover {
      background: #16a34a;
    }
    #car-list {
      max-width: 1000px;
      margin: 0 auto 40px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      padding: 0 16px;
    }
    .car-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .car-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .car-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .car-info {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .car-info h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: #0f172a;
    }
    .car-info p.description {
      font-size: 0.9rem;
      color: #475569;
      line-height: 1.4;
      margin: 0;
    }
    .car-info p.price-location {
      font-weight: 600;
      font-size: 1rem;
      color: #2563eb;
      margin: 0;
    }
    .car-info .tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .badge {
      background: #3b82f6;
      color: #fff;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .verified-badge {
      background: #22c55e;
      color: #fff;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .rating {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.9rem;
      color: #eab308;
    }
    .history {
      font-size: 0.8rem;
      color: #475569;
    }
    .reserve-btn {
      background: #22c55e;
      color: #fff;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    .reserve-btn:hover {
      background: #16a34a;
    }
    .favorite-btn {
      background: #f59e0b;
      color: #fff;
      padding: 8px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 8px;
    }
    #loader {
      text-align: center;
      padding: 24px;
      color: #475569;
      font-weight: 600;
      display: none;
    }
    .referral-section {
      max-width: 1000px;
      margin: 24px auto;
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }
    .language-currency {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    @media (max-width: 768px) {
      .filters {
        grid-template-columns: 1fr;
      }
      .filters button {
        width: 100%;
      }
      .car-card img {
        height: 160px;
      }
      .auth-section span {
        max-width: 150px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo" tabindex="0" role="heading" aria-level="1" aria-label="Accueil AutoRent" onclick="window.location.href='index.html'">AutoRent</div>
    <nav aria-label="Navigation principale">
      <a href="mes-reservations.html" class="btn-auth" id="reservations-link" style="display: none;">Mes Réservations</a>
      <a href="dashboard.html" class="btn-auth" id="dashboard-link" style="display: none;">Dashboard Analytics</a>
    </nav>
    <div class="auth-section" id="auth-section">
      <button class="btn-auth" id="btn-auth" aria-label="Se connecter">Connexion</button>
    </div>
    <div class="language-currency">
      <select id="language-select" aria-label="Choisir la langue">
        <option value="fr">Français</option>
        <option value="en">English</option>
      </select>
      <select id="currency-select" aria-label="Choisir la devise">
        <option value="MAD">MAD</option>
        <option value="EUR">EUR</option>
        <option value="USD">USD</option>
      </select>
    </div>
  </header>

  <section class="referral-section" aria-label="Programme de parrainage">
    <h3>Programme de Parrainage</h3>
    <p>Invitez vos amis et gagnez des bonus ! Partagez votre lien : <span id="referral-link"></span></p>
    <button id="copy-referral" class="btn-auth">Copier le lien</button>
  </section>

  <section class="filters" aria-label="Filtres de recherche pour les voitures">
    <div>
      <label for="location">Ville</label>
      <input type="text" id="location" placeholder="Ex: Casablanca" aria-label="Rechercher par ville">
    </div>
    <div>
      <label for="startDate">Date de début</label>
      <input type="date" id="startDate" aria-label="Date de début de location" min="2025-07-11">
    </div>
    <div>
      <label for="endDate">Date de fin</label>
      <input type="date" id="endDate" aria-label="Date de fin de location" min="2025-07-11">
    </div>
    <div>
      <label for="priceRange">Prix par jour</label>
      <select id="priceRange" aria-label="Filtrer par prix">
        <option value="">Tous</option>
        <option value="0-200">0 - 200 MAD</option>
        <option value="201-500">201 - 500 MAD</option>
        <option value="501-1000">501 - 1000 MAD</option>
        <option value="1000+">1000+ MAD</option>
      </select>
    </div>
    <div>
      <label for="carType">Type</label>
      <select id="carType" aria-label="Filtrer par type de voiture">
        <option value="">Tous</option>
        <option value="berline">Berline</option>
        <option value="SUV">SUV</option>
        <option value="citadine">Citadine</option>
        <option value="utilitaire">Utilitaire</option>
      </select>
    </div>
    <div>
      <label for="transmission">Transmission</label>
      <select id="transmission" aria-label="Filtrer par transmission">
        <option value="">Tous</option>
        <option value="manuelle">Manuelle</option>
        <option value="automatique">Automatique</option>
      </select>
    </div>
    <div>
      <label for="sortOrder">Trier par prix</label>
      <select id="sortOrder" aria-label="Trier par prix">
        <option value="asc">Croissant</option>
        <option value="desc">Décroissant</option>
      </select>
    </div>
    <button id="btnApplyFilters" aria-label="Appliquer les filtres">Rechercher</button>
  </section>

  <main id="car-list" aria-live="polite"></main>
  <div id="loader" aria-hidden="true">Chargement...</div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getFirestore, collection, query, where, orderBy, limit, startAfter, onSnapshot, doc, updateDoc, arrayUnion, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging.js'; // Pour notifications push
    import { firebaseConfig } from './js/firebase.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const messaging = getMessaging(app); // Initialisation pour push notifications

    const carList = document.getElementById("car-list");
    const loader = document.getElementById("loader");
    const authSection = document.getElementById("auth-section");
    let filters = {};
    let lastVisible = null;
    let isLoading = false;
    let currentCurrency = 'MAD';
    let exchangeRates = { EUR: 0.09, USD: 0.1 }; // Exemples de taux ; à charger dynamiquement si possible
    let currentUser = null;

    // Initialisation i18next pour multilingue
    i18next.use(i18nextHttpBackend).init({
      lng: 'fr',
      fallbackLng: 'fr',
      backend: { loadPath: '/locales/{{lng}}/translation.json' } // Suppose des fichiers JSON pour traductions
    }, () => {
      updateUIWithLanguage();
    });

    function updateUIWithLanguage() {
      // Mettre à jour les textes avec i18next.t('key')
      document.querySelector('.logo').textContent = i18next.t('Autorent');
      // Ajouter d'autres éléments...
    }

    // Changement de langue
    document.getElementById('language-select').addEventListener('change', (e) => {
      i18next.changeLanguage(e.target.value, updateUIWithLanguage);
    });

    // Changement de devise
    document.getElementById('currency-select').addEventListener('change', (e) => {
      currentCurrency = e.target.value;
      loadCars(true); // Recharger pour convertir prix
    });

    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Update auth UI
    function updateAuthUI(user) {
      currentUser = user;
      const reservationsLink = document.getElementById("reservations-link");
      const dashboardLink = document.getElementById("dashboard-link");
      if (user) {
        authSection.innerHTML = `
          <span title="Connecté en tant que ${DOMPurify.sanitize(user.email)}">${DOMPurify.sanitize(user.email)}</span>
          <button class="btn-auth" id="btn-logout" aria-label="Se déconnecter">Déconnexion</button>
        `;
        reservationsLink.style.display = "inline-block";
        dashboardLink.style.display = "inline-block"; // Lien vers dashboard analytics
        document.getElementById("btn-logout").addEventListener("click", () => {
          signOut(auth).then(() => {
            Toastify({ text: "Déconnexion réussie.", duration: 3000, backgroundColor: "#4ade80" }).showToast();
            window.location.href = "index.html";
          }).catch(err => {
            Toastify({ text: `Erreur déconnexion: ${err.message}`, duration: 3000, backgroundColor: "#ef4444" }).showToast();
          });
        });
        setupPushNotifications(user);
        setupReferral(user);
      } else {
        authSection.innerHTML = `<button class="btn-auth" id="btn-auth" aria-label="Se connecter">Connexion</button>`;
        reservationsLink.style.display = "none";
        dashboardLink.style.display = "none";
        document.getElementById("btn-auth").addEventListener("click", () => {
          window.location.href = "connexion.html";
        });
      }
    }

    // Setup push notifications
    function setupPushNotifications(user) {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          getToken(messaging, { vapidKey: 'VOTRE_VAPID_KEY' }).then(token => {
            updateDoc(doc(db, 'users', user.uid), { fcmToken: token });
          });
        }
      });
      onMessage(messaging, payload => {
        Toastify({ text: payload.notification.body, duration: 3000, backgroundColor: "#4ade80" }).showToast();
      });
    }

    // Programme de parrainage
    async function setupReferral(user) {
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      let referralCode = userDoc.data()?.referralCode;
      if (!referralCode) {
        referralCode = Math.random().toString(36).substring(2, 10);
        await updateDoc(doc(db, 'users', user.uid), { referralCode });
      }
      document.getElementById('referral-link').textContent = `${window.location.origin}?ref=${referralCode}`;
      document.getElementById('copy-referral').addEventListener('click', () => {
        navigator.clipboard.writeText(document.getElementById('referral-link').textContent);
        Toastify({ text: "Lien copié !", duration: 3000, backgroundColor: "#4ade80" }).showToast();
      });
      // Bonus : Sur inscription avec ref, ajouter bonus à Firestore (implémenter dans connexion.js)
    }

    // Vérifier disponibilité
    async function isCarAvailable(carId, start, end) {
      const snapshot = await getDocs(query(collection(db, "reservations"), where("carId", "==", carId), where("status", "==", "confirmed")));
      return !snapshot.docs.some(doc => {
        const r = doc.data();
        const rs = r.startDate.toDate();
        const re = r.endDate.toDate();
        return start <= re && end >= rs;
      });
    }

    // Charger voitures avec améliorations
    async function loadCars(isNewSearch = false) {
      if (isLoading) return;
      isLoading = true;
      loader.style.display = "block";

      try {
        let constraints = [where("disponible", "==", true)];
        const startDate = filters.startDate ? new Date(filters.startDate) : null;
        const endDate = filters.endDate ? new Date(filters.endDate) : null;

        if (filters.priceRange) {
          if (filters.priceRange === "1000+") {
            constraints.push(where("prix", ">", 1000));
          } else {
            const [min, max] = filters.priceRange.split("-");
            constraints.push(where("prix", ">=", parseInt(min)));
            if (max) constraints.push(where("prix", "<=", parseInt(max)));
          }
        }
        if (filters.location) {
          const loc = filters.location.toLowerCase();
          constraints.push(where("location", ">=", loc));
          constraints.push(where("location", "<=", loc + "\uf8ff"));
        }
        if (filters.carType) constraints.push(where("type", "==", filters.carType));
        if (filters.transmission) constraints.push(where("transmission", "==", filters.transmission));
        constraints.push(orderBy("prix", filters.sortOrder || "asc"));
        if (lastVisible && !isNewSearch) constraints.push(startAfter(lastVisible));

        const q = query(collection(db, "cars"), ...constraints, limit(8));
        const unsubscribe = onSnapshot(q, async snapshot => {
          if (snapshot.empty) {
            carList.innerHTML = `<p style="text-align:center; color:#475569; font-weight:600;" aria-live="polite">Aucune voiture trouvée.</p>`;
            loader.style.display = "none";
            isLoading = false;
            return;
          }
          if (isNewSearch) carList.innerHTML = "";

          for (const docSnap of snapshot.docs) {
            const car = docSnap.data();
            let isAvailable = true;
            if (startDate && endDate) {
              isAvailable = await isCarAvailable(docSnap.id, startDate, endDate);
            }
            if (!isAvailable) continue;

            // Fetch reviews, history, verified from owner
            const ownerDoc = await getDoc(doc(db, 'users', car.ownerId));
            const owner = ownerDoc.data() || {};
            const verified = owner.verified ? '<span class="verified-badge">Vérifié</span>' : '';
            const rentalsCount = owner.rentalsCount || 0;
            const satisfaction = owner.satisfactionRate || 'N/A';
            const reviewsSnap = await getDocs(query(collection(db, 'reviews'), where('carId', '==', docSnap.id)));
            let rating = 0;
            if (!reviewsSnap.empty) {
              rating = reviewsSnap.docs.reduce((acc, d) => acc + d.data().rating, 0) / reviewsSnap.docs.length;
            }

            // Conversion devise
            let price = car.prix;
            if (currentCurrency !== 'MAD') {
              price = Math.round(price * exchangeRates[currentCurrency]);
            }
            const currencySymbol = currentCurrency === 'EUR' ? '€' : currentCurrency === 'USD' ? '$' : 'MAD';

            // Calcul frais auto (ex: 10% commission)
            const commission = 0.1;
            const netPrice = price * (1 - commission);

            const safeName = DOMPurify.sanitize(car.nom || "Voiture");
            const safeDesc = DOMPurify.sanitize(car.description || "");
            const safeLoc = DOMPurify.sanitize(car.location || "Inconnue");
            carList.insertAdjacentHTML("beforeend", `
              <article class="car-card" aria-label="Voiture ${safeName}">
                <img src="${car.imageUrl || 'images/default-car.jpg'}" alt="Photo de ${safeName}" loading="lazy">
                <div class="car-info">
                  <h3>${safeName}</h3>
                  <p class="description">${safeDesc}</p>
                  <p class="price-location">${price} ${currencySymbol} (Net loueur: ${netPrice} ${currencySymbol}) - ${safeLoc}</p>
                  <div class="tags" aria-label="Informations complémentaires">
                    <span class="badge">${DOMPurify.sanitize(car.type || 'N/A')}</span>
                    <span class="badge">${DOMPurify.sanitize(car.transmission || 'N/A')}</span>
                    ${verified}
                  </div>
                  <div class="rating">★ ${rating.toFixed(1)} / 5</div>
                  <div class="history">Locations: ${rentalsCount} | Satisfaction: ${satisfaction}%</div>
                  <button class="reserve-btn" aria-label="Réserver ${safeName}" onclick="reserveCar('${docSnap.id}')">Réserver</button>
                  <button class="favorite-btn" aria-label="Ajouter aux favoris" onclick="addToFavorites('${docSnap.id}')">❤️ Favoris</button>
                </div>
              </article>
            `);
          }
          lastVisible = snapshot.docs[snapshot.docs.length - 1];
          loader.style.display = "none";
          isLoading = false;
        }, err => {
          Toastify({ text: `Erreur: ${err.message}`, duration: 3000, backgroundColor: "#ef4444" }).showToast();
          loader.style.display = "none";
          isLoading = false;
        });
      } catch (err) {
        Toastify({ text: `Erreur: ${err.message}`, duration: 3000, backgroundColor: "#ef4444" }).showToast();
        loader.style.display = "none";
        isLoading = false;
      }
    }

    // Ajouter aux favoris
    window.addToFavorites = async function(carId) {
      if (!currentUser) {
        Toastify({ text: "Veuillez vous connecter.", duration: 3000, backgroundColor: "#ef4444" }).showToast();
        return;
      }
      await updateDoc(doc(db, 'users', currentUser.uid), {
        favorites: arrayUnion(carId)
      });
      Toastify({ text: "Ajouté aux favoris !", duration: 3000, backgroundColor: "#4ade80" }).showToast();
    };

    window.reserveCar = function(carId) {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const url = new URL("reserver-voiture.html", window.location.origin);
      url.searchParams.set("carId", carId);
      if (startDate) url.searchParams.set("startDate", startDate);
      if (endDate) url.searchParams.set("endDate", endDate);
      window.location.href = url.toString();
    };

    const applyFilters = debounce(() => {
      filters = {
        location: document.getElementById("location").value.trim(),
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        priceRange: document.getElementById("priceRange").value,
        carType: document.getElementById("carType").value,
        transmission: document.getElementById("transmission").value,
        sortOrder: document.getElementById("sortOrder").value
      };
      if (filters.startDate && filters.endDate && new Date(filters.endDate) <= new Date(filters.startDate)) {
        Toastify({ text: "La date de fin doit être après la date de début.", duration: 3000, backgroundColor: "#ef4444" }).showToast();
        return;
      }
      lastVisible = null;
      loadCars(true);
    }, 500);

    document.getElementById("btnApplyFilters").addEventListener("click", applyFilters);
    document.getElementById("location").addEventListener("input", applyFilters);
    document.getElementById("startDate").addEventListener("input", applyFilters);
    document.getElementById("endDate").addEventListener("input", applyFilters);
    document.getElementById("priceRange").addEventListener("change", applyFilters);
    document.getElementById("carType").addEventListener("change", applyFilters);
    document.getElementById("transmission").addEventListener("change", applyFilters);
    document.getElementById("sortOrder").addEventListener("change", applyFilters);

    onAuthStateChanged(auth, user => {
      updateAuthUI(user);
    });

    window.addEventListener("offline", () => {
      Toastify({ text: "Vous êtes hors ligne.", duration: -1, backgroundColor: "#ef4444" }).showToast();
    });
    window.addEventListener("online", () => {
      Toastify({ text: "Connexion rétablie.", duration: 3000, backgroundColor: "#4ade80" }).showToast();
      loadCars(true);
    });

    loadCars(true);

    const observer = new IntersectionObserver(entries => {
      if (entries[0].isIntersecting && !isLoading) loadCars();
    }, { rootMargin: "100px" });
    observer.observe(loader);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</body>
</html>
