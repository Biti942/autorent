<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GÃ©rance Agence - AutoRent</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: #f8fafc;
      color: #1e293b;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 24px;
    }
    header {
      position: sticky;
      top: 0;
      background: #0f172a;
      color: #fff;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
    }
    .logo {
      font-weight: 700;
      font-size: 1.8rem;
      cursor: pointer;
      user-select: none;
    }
    .auth-section {
      display: flex;
      align-items: center;
      gap: 16px;
      font-weight: 600;
    }
    .auth-section span {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .btn-auth {
      background: #3b82f6;
      color: #fff;
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    .btn-auth:hover {
      background: #2563eb;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      color: #0f172a;
      margin: 24px 0;
    }
    .section-title {
      max-width: 1000px;
      margin: 40px auto 16px;
      font-size: 1.5rem;
      color: #0f172a;
      padding: 0 16px;
    }
    .filter-container {
      max-width: 1000px;
      margin: 0 auto 16px;
      padding: 0 16px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .filter-container input, .filter-container select {
      padding: 10px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1e293b;
      outline-offset: 2px;
      outline-color: #3b82f6;
      flex: 1;
      min-width: 150px;
    }
    .add-car-btn {
      background: #22c55e;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    .add-car-btn:hover {
      background: #16a34a;
    }
    .table-container {
      max-width: 1000px;
      margin: 0 auto 40px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
    }
    th {
      background: #0f172a;
      color: #fff;
      font-weight: 600;
    }
    tr:hover {
      background: #f1f5f9;
    }
    .action-btn {
      background: #22c55e;
      color: #fff;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
      margin: 0 4px;
    }
    .action-btn.reject {
      background: #ef4444;
    }
    .action-btn:hover {
      background: #16a34a;
    }
    .action-btn.reject:hover {
      background: #dc2626;
    }
    .skeleton {
      background: linear-gradient(90deg, #e5e7eb 25%, #f1f5f9 50%, #e5e7eb 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      height: 20px;
      border-radius: 4px;
      margin: 4px 0;
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .chart-container {
      max-width: 1000px;
      margin: 0 auto 40px;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .chart-container h2 {
      font-size: 1.5rem;
      color: #0f172a;
      text-align: center;
      margin-bottom: 16px;
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
    }
    #ia-analysis {
      max-width: 1000px;
      margin: 0 auto 40px;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      font-size: 1rem;
      line-height: 1.8;
      color: #1e293b;
    }
    #ia-analysis h2 {
      font-size: 1.5rem;
      color: #0f172a;
      margin-bottom: 16px;
    }
    #ia-analysis strong {
      color: #2563eb;
    }
    #loader {
      text-align: center;
      padding: 24px;
      color: #475569;
      font-weight: 600;
      display: none;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      font-size: 1.5rem;
      color: #0f172a;
      margin-bottom: 16px;
    }
    .modal-content label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1e293b;
    }
    .modal-content input, .modal-content select {
      width: 100%;
      padding: 10px;
      margin-bottom: 16px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1e293b;
    }
    .modal-content button {
      background: #22c55e;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .modal-content button:hover {
      background: #16a34a;
    }
    .modal-content .close-btn {
      background: #ef4444;
      float: right;
    }
    .modal-content .close-btn:hover {
      background: #dc2626;
    }
    @media (max-width: 768px) {
      .filter-container {
        flex-direction: column;
      }
      .table-container {
        overflow-x: auto;
      }
      .action-btn {
        padding: 6px 12px;
        font-size: 0.8rem;
      }
      .auth-section span {
        max-width: 150px;
      }
      canvas {
        height: 300px !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo" tabindex="0" role="heading" aria-level="1" aria-label="GÃ©rance Agence AutoRent">AutoRent Agence</div>
    <div class="auth-section" id="auth-section">
      <span id="user-email" aria-label="Email de l'utilisateur connectÃ©"></span>
      <button class="btn-auth" id="btn-logout" aria-label="Se dÃ©connecter">DÃ©connexion</button>
    </div>
  </header>

  <h1>ðŸ“˜ GÃ©rance Agence - Pack Premium</h1>

  <div class="section-title">ðŸ“‹ Demandes de RÃ©servations</div>
  <div class="filter-container">
    <input type="text" id="resFilter" placeholder="Filtrer par client ou voiture" aria-label="Filtrer les rÃ©servations par client ou voiture">
    <select id="resStatusFilter" aria-label="Filtrer par statut de rÃ©servation">
      <option value="">Tous</option>
      <option value="pending">En attente</option>
      <option value="confirmed">ConfirmÃ©</option>
      <option value="rejected">RejetÃ©</option>
    </select>
  </div>
  <div class="table-container">
    <table id="reservations-table" aria-live="polite">
      <thead>
        <tr>
          <th>Client</th>
          <th>Voiture</th>
          <th>DÃ©but</th>
          <th>Fin</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="reservations-table-body">
        <tr><td colspan="7"><div class="skeleton"></div></td></tr>
        <tr><td colspan="7"><div class="skeleton"></div></td></tr>
        <tr><td colspan="7"><div class="skeleton"></div></td></tr>
      </tbody>
    </table>
  </div>

  <div class="section-title">ðŸš— Gestion de la Flotte</div>
  <div class="filter-container">
    <input type="text" id="fleetFilter" placeholder="Filtrer par nom de voiture" aria-label="Filtrer les voitures par nom">
    <select id="statusFilter" aria-label="Filtrer par disponibilitÃ©">
      <option value="">Tous</option>
      <option value="true">Disponible</option>
      <option value="false">Non disponible</option>
    </select>
    <button class="add-car-btn" id="addCarBtn" aria-label="Ajouter une voiture">Ajouter Voiture</button>
  </div>
  <div class="table-container">
    <table id="fleet-table" aria-live="polite">
      <thead>
        <tr>
          <th>Voiture</th>
          <th>Type</th>
          <th>Location</th>
          <th>Vidange</th>
          <th>KilomÃ©trage</th>
          <th>CrÃ©dit/Mois</th>
          <th>DÃ©penses</th>
          <th>CA</th>
          <th>RÃ©servations Actives</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="fleet-table-body">
        <tr><td colspan="10"><div class="skeleton"></div></td></tr>
        <tr><td colspan="10"><div class="skeleton"></div></td></tr>
        <tr><td colspan="10"><div class="skeleton"></div></td></tr>
      </tbody>
    </table>
  </div>

  <div class="chart-container">
    <h2>ðŸ“Š RÃ©sumÃ© Financier Mensuel</h2>
    <canvas id="financeChart"></canvas>
  </div>

  <div id="ia-analysis" aria-live="polite">
    <h2>ðŸ¤– Analyse IA des Performances</h2>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
  </div>

  <div id="addCarModal" class="modal">
    <div class="modal-content">
      <h2>Ajouter une voiture</h2>
      <button class="close-btn" id="closeModalBtn" aria-label="Fermer">Fermer</button>
      <form id="addCarForm">
        <label for="carName">Nom</label>
        <input type="text" id="carName" required aria-label="Nom de la voiture">
        <label for="carType">Type</label>
        <select id="carType" required aria-label="Type de voiture">
          <option value="berline">Berline</option>
          <option value="SUV">SUV</option>
          <option value="citadine">Citadine</option>
          <option value="utilitaire">Utilitaire</option>
        </select>
        <label for="carLocation">Ville</label>
        <input type="text" id="carLocation" required aria-label="Ville de disponibilitÃ©">
        <label for="carTransmission">Transmission</label>
        <select id="carTransmission" required aria-label="Type de transmission">
          <option value="manuelle">Manuelle</option>
          <option value="automatique">Automatique</option>
        </select>
        <label for="carPrice">Prix/jour (MAD)</label>
        <input type="number" id="carPrice" required min="0" aria-label="Prix par jour">
        <label for="carVidange">Vidange (km)</label>
        <input type="text" id="carVidange" aria-label="Prochain kilomÃ©trage pour vidange">
        <label for="carKilometrage">KilomÃ©trage (km)</label>
        <input type="number" id="carKilometrage" min="0" aria-label="KilomÃ©trage actuel">
        <label for="carCredit">CrÃ©dit/Mois (MAD)</label>
        <input type="number" id="carCredit" min="0" aria-label="CrÃ©dit mensuel">
        <label for="carDepenses">DÃ©penses (MAD)</label>
        <input type="number" id="carDepenses" min="0" aria-label="DÃ©penses totales">
        <button type="submit" aria-label="Ajouter la voiture">Ajouter</button>
      </form>
    </div>
  </div>

  <div id="loader" aria-hidden="true">Chargement...</div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, addDoc, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
    import { firebaseConfig } from './js/firebase.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const reservationsTableBody = document.getElementById("reservations-table-body");
    const fleetTableBody = document.getElementById("fleet-table-body");
    const iaAnalysis = document.getElementById("ia-analysis");
    const userEmail = document.getElementById("user-email");
    const loader = document.getElementById("loader");
    const authSection = document.getElementById("auth-section");
    let chartInstance = null;
    let unsubscribeReservations = null;
    let unsubscribeFleet = null;

    // Debounce function for filter inputs
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Update auth UI
    function updateAuthUI(user) {
      if (user) {
        userEmail.textContent = DOMPurify.sanitize(user.email);
      } else {
        if (unsubscribeReservations) unsubscribeReservations();
        if (unsubscribeFleet) unsubscribeFleet();
        window.location.href = "connexion.html";
      }
    }

    // Check if user is admin
    async function isAdmin(user) {
      const adminDoc = await getDoc(doc(db, "admins", user.uid));
      return adminDoc.exists();
    }

    // Toggle car availability with confirmation
    window.toggleAvailability = async function(carId, disponible) {
      if (!confirm(`Voulez-vous vraiment ${disponible ? "dÃ©sactiver" : "activer"} cette voiture ?`)) return;
      try {
        const carRef = doc(db, "cars", carId);
        const carDoc = await getDoc(carRef);
        if (carDoc.exists() && carDoc.data().uid !== auth.currentUser.uid) {
          throw new Error("Vous n'Ãªtes pas autorisÃ© Ã  modifier cette voiture.");
        }
        await updateDoc(carRef, { disponible: !disponible });
        Toastify({ text: `Voiture ${!disponible ? "activÃ©e" : "dÃ©sactivÃ©e"} avec succÃ¨s.`, duration: 3000, backgroundColor: "#4ade80" }).showToast();
      } catch (err) {
        Toastify({ text: `Erreur: ${err.message}`, duration: 3000, backgroundColor: "#ef4444" }).showToast();
      }
    };

    // Update reservation status with confirmation
    window.updateReservation = async function(resId, status) {
      if (!confirm(`Voulez-vous vraiment ${status === "confirmed" ? "approuver" : "rejeter"} cette rÃ©servation ?`)) return;
      try {
        const resRef = doc(db, "reservations", resId);
        const resDoc = await getDoc(resRef);
        if (resDoc.exists() && resDoc.data().agencyId !== auth.currentUser.uid) {
          throw new Error("Vous n'Ãªtes pas autorisÃ© Ã  modifier cette rÃ©servation.");
        }
        await updateDoc(resRef, { status });
        Toastify({ text: `RÃ©servation ${status === "confirmed" ? "approuvÃ©e" : "rejetÃ©e"} avec succÃ¨s.`, duration: 3000, backgroundColor: "#4ade80" }).showToast();
      } catch (err) {
        Toastify({ text: `Erreur: ${err.message}`, duration: 3000, backgroundColor: "#ef4444" }).showToast();
      }
    };

    // Add new car
    async function addCar(event) {
      event.preventDefault();
      const form = event.target;
      const carData = {
        nom: DOMPurify.sanitize(form.carName.value),
        type: form.carType.value,
        location: DOMPurify.sanitize(form.carLocation.value),
        transmission: form.carTransmission.value,
        prix: parseFloat(form.carPrice.value) || 0,
        vidange: DOMPurify.sanitize(form.carVidange.value) || null,
        kilometrage: parseInt(form.carKilometrage.value) || 0,
        credit: parseFloat(form.carCredit.value) || 0,
        depenses: parseFloat(form.carDepenses.value) || 0,
        ca: 0,
        disponible: true,
        uid: auth.currentUser.uid
      };
      try {
        await addDoc(collection(db, "cars"), carData);
        Toastify({ text: "Voiture ajoutÃ©e avec succÃ¨s.", duration: 3000, backgroundColor: "#4ade80" }).showToast();
        document.getElementById("addCarModal").style.display = "none";
        form.reset();
      } catch (err) {
        Toastify({ text: `Erreur: ${err.message}`, duration: 3000, backgroundColor: "#ef4444" }).showToast();
      }
    }

    // Filter reservations
    const filterReservations = debounce(() => {
      const filter = document.getElementById("resFilter").value.toLowerCase();
      const status = document.getElementById("resStatusFilter").value;
      const rows = reservationsTableBody.getElementsByTagName("tr");
      for (let row of rows) {
        const client = row.cells[0].textContent.toLowerCase();
        const car = row.cells[1].textContent.toLowerCase();
        const resStatus = row.cells[5].textContent.toLowerCase();
        const textMatch = client.includes(filter) || car.includes(filter);
        const statusMatch = !status || resStatus === status;
        row.style.display = textMatch && statusMatch ? "" : "none";
      }
    }, 300);

    // Filter fleet
    const filterFleet = debounce(() => {
      const filter = document.getElementById("fleetFilter").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;
      const rows = fleetTableBody.getElementsByTagName("tr");
      for (let row of rows) {
        const name = row.cells[0].textContent.toLowerCase();
        const disponible = row.cells[9].querySelector("button").textContent === "DÃ©sactiver" ? "true" : "false";
        const nameMatch = name.includes(filter);
        const statusMatch = !status || disponible === status;
        row.style.display = nameMatch && statusMatch ? "" : "none";
      }
    }, 300);

    // Load reservations
    function loadReservations(user) {
      return new Promise((resolve, reject) => {
        reservationsTableBody.innerHTML = `
          <tr><td colspan="7"><div class="skeleton"></div></td></tr>
          <tr><td colspan="7"><div class="skeleton"></div></td></tr>
          <tr><td colspan="7"><div class="skeleton"></div></td></tr>
        `;
        const q = query(collection(db, "reservations"), where("agencyId", "==", user.uid));
        unsubscribeReservations = onSnapshot(q, async snapshot => {
          const resDocs = snapshot.docs;
          const carPromises = resDocs.map(d => getDoc(doc(db, "cars", d.data().carId)));
          const userPromises = resDocs.map(d => getDoc(doc(db, "utilisateurs", d.data().userId)));
          try {
            const [carDocs, userDocs] = await Promise.all([Promise.all(carPromises), Promise.all(userPromises)]);
            reservationsTableBody.innerHTML = "";
            for (let i = 0; i < resDocs.length; i++) {
              const res = resDocs[i].data();
              const carName = carDocs[i].exists() ? DOMPurify.sanitize(carDocs[i].data().nom) : "Inconnu";
              const userEmail = userDocs[i].exists() ? DOMPurify.sanitize(userDocs[i].data().email) : "Inconnu";
              const start = res.startDate ? new Date(res.startDate.toDate()).toLocaleDateString('fr-FR') : "-";
              const end = res.endDate ? new Date(res.endDate.toDate()).toLocaleDateString('fr-FR') : "-";
              reservationsTableBody.insertAdjacentHTML("beforeend", `
                <tr>
                  <td>${userEmail}</td>
                  <td>${carName}</td>
                  <td>${start}</td>
                  <td>${end}</td>
                  <td>${res.totalPrice || "-"} DH</td>
                  <td>${DOMPurify.sanitize(res.status)}</td>
                  <td>
                    ${res.status === "pending" ? `
                      <button class="action-btn" onclick="updateReservation('${resDocs[i].id}', 'confirmed')" aria-label="Approuver la rÃ©servation">Approuver</button>
                      <button class="action-btn reject" onclick="updateReservation('${resDocs[i].id}', 'rejected')" aria-label="Rejeter la rÃ©servation">Rejeter</button>
                    ` : "-"}
                  </td>
                </tr>
              `);
            }
            filterReservations();
            resolve();
          } catch (err) {
            reject(err);
          }
        }, err => reject(err));
      });
    }

    // Load fleet
    function loadFleet(user, reservationsSnapshot) {
      return new Promise((resolve, reject) => {
        fleetTableBody.innerHTML = `
          <tr><td colspan="10"><div class="skeleton"></div></td></tr>
          <tr><td colspan="10"><div class="skeleton"></div></td></tr>
          <tr><td colspan="10"><div class="skeleton"></div></td></tr>
        `;
        const q = query(collection(db, "cars"), where("uid", "==", user.uid));
        unsubscribeFleet = onSnapshot(q, async snapshot => {
          try {
            const fleetData = [];
            const monthlyData = {};
            const today = new Date();
            const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 5, 1);
            let totalDepenses = 0;
            let totalCredit = 0;

            // Aggregate reservations by carId
            const carReservations = {};
            reservationsSnapshot.forEach(resDoc => {
              const res = resDoc.data();
              if (res.status === "confirmed" && res.endDate.toDate() >= sixMonthsAgo) {
                const carId = res.carId;
                carReservations[carId] = carReservations[carId] || [];
                carReservations[carId].push(res);
              }
            });

            const updates = [];
            for (const carDoc of snapshot.docs) {
              const car = carDoc.data();
              car.id = carDoc.id;
              fleetData.push(car);

              totalDepenses += parseFloat(car.depenses || 0);
              totalCredit += parseFloat(car.credit || 0);

              let activeReservations = 0;
              let carCA = 0;
              const resList = carReservations[car.id] || [];
              resList.forEach(res => {
                if (res.endDate.toDate() >= today && res.startDate.toDate() <= today) activeReservations++;
                const resMonth = res.startDate.toDate().toLocaleString('fr-FR', { month: 'short', year: 'numeric' });
                monthlyData[resMonth] = monthlyData[resMonth] || { ca: 0, depenses: totalDepenses, credit: totalCredit };
                monthlyData[resMonth].ca += parseFloat(res.totalPrice || 0);
                carCA += parseFloat(res.totalPrice || 0);
              });

              if (carCA !== parseFloat(car.ca || 0)) {
                updates.push(updateDoc(doc(db, "cars", car.id), { ca: carCA }));
              }

              fleetTableBody.insertAdjacentHTML("beforeend", `
                <tr>
                  <td>${DOMPurify.sanitize(car.nom || "N/A")}</td>
                  <td>${DOMPurify.sanitize(car.type || "N/A")}</td>
                  <td>${DOMPurify.sanitize(car.location || "N/A")}</td>
                  <td>${DOMPurify.sanitize(car.vidange || "-")}</td>
                  <td>${car.kilometrage || "-"}</td>
                  <td>${car.credit || "-"} DH</td>
                  <td>${car.depenses || "-"} DH</td>
                  <td>${carCA.toFixed(2)} DH</td>
                  <td>${activeReservations}</td>
                  <td>
                    <button class="action-btn" onclick="toggleAvailability('${car.id}', ${car.disponible})" aria-label="${car.disponible ? "DÃ©sactiver" : "Activer"} la voiture">
                      ${car.disponible ? "DÃ©sactiver" : "Activer"}
                    </button>
                  </td>
                </tr>
              `);
            }

            await Promise.all(updates);

            filterFleet();
            updateChart(monthlyData, today, totalDepenses, totalCredit);
            const pendingCount = reservationsSnapshot.docs.filter(d => d.data().status === "pending").length;
            updateAIAnalysis(fleetData, reservationsSnapshot.size, pendingCount);
            resolve();
          } catch (err) {
            reject(err);
          }
        }, err => reject(err));
      });
    }

    // Update financial chart
    function updateChart(monthlyData, today, totalDepenses, totalCredit) {
      if (chartInstance) chartInstance.destroy();
      const ctx = document.getElementById("financeChart").getContext("2d");
      const months = Array.from({length: 6}, (_, i) => {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        return date.toLocaleString('fr-FR', { month: 'short', year: 'numeric' });
      }).reverse();

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Chiffre d\'Affaires',
              data: months.map(m => monthlyData[m]?.ca || 0),
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34, 197, 94, 0.2)',
              tension: 0.4
            },
            {
              label: 'DÃ©penses',
              data: months.map(() => totalDepenses),
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.2)',
              tension: 0.4
            },
            {
              label: 'CrÃ©dit Mensuel',
              data: months.map(() => totalCredit),
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              tension: 0.4
            }
          ]
        },
        options: {
          scales: {
            y: { beginAtZero: true, ticks: { color: '#1e293b' } },
            x: { ticks: { color: '#1e293b' } }
          },
          plugins: {
            legend: { labels: { color: '#1e293b' } }
          }
        }
      });
    }

    // Update AI analysis
    function updateAIAnalysis(fleetData, totalReservations, pendingCount) {
      let totalCA = 0, totalDepenses = 0, totalCredit = 0;
      let bestCar = null, maxCA = 0;
      let minCreditCar = null, minCredit = Number.MAX_VALUE;
      let highMileageCars = 0;

      fleetData.forEach(car => {
        const ca = parseFloat(car.ca || 0);
        const depenses = parseFloat(car.depenses || 0);
        const credit = parseFloat(car.credit || 0);
        totalCA += ca;
        totalDepenses += depenses;
        totalCredit += credit;
        if (ca > maxCA) {
          maxCA = ca;
          bestCar = car;
        }
        if (credit && credit < minCredit) {
          minCredit = credit;
          minCreditCar = car;
        }
        if (car.kilometrage > 100000) highMileageCars++;
      });

      const benefice = totalCA - totalDepenses - totalCredit;
      const reservationsPerCar = fleetData.length ? totalReservations / fleetData.length : 0;
      const analysisText = `
        <p><strong>Total CA:</strong> ${totalCA.toFixed(2)} DH</p>
        <p><strong>DÃ©penses totales:</strong> ${totalDepenses.toFixed(2)} DH</p>
        <p><strong>CrÃ©dit mensuel cumulÃ©:</strong> ${totalCredit.toFixed(2)} DH</p>
        <p><strong>BÃ©nÃ©fice estimÃ©:</strong> <span style="color:${benefice > 0 ? '#22c55e' : '#ef4444'}">${benefice.toFixed(2)} DH</span></p>
        <p><strong>Total rÃ©servations:</strong> ${totalReservations}</p>
        <p><strong>RÃ©servations en attente:</strong> ${pendingCount}</p>
        <p><strong>Meilleure voiture:</strong> ${bestCar ? DOMPurify.sanitize(bestCar.nom) : "Aucune"} (${maxCA.toFixed(2)} DH CA)</p>
        <p><strong>Voiture la plus Ã©conomique:</strong> ${minCreditCar ? DOMPurify.sanitize(minCreditCar.nom) : "Aucune"} (${minCredit.toFixed(2)} DH crÃ©dit)</p>
        <p><strong>Voitures Ã  fort kilomÃ©trage (>100k km):</strong> ${highMileageCars}</p>
        <p><strong>PrÃ©visions (basÃ© sur les 6 derniers mois):</strong></p>
        <ul>
          <li>CA mensuel moyen: ${(totalCA / 6).toFixed(2)} DH</li>
          <li>Taux de rÃ©servation: ${reservationsPerCar.toFixed(2)} rÃ©servations/voiture</li>
        </ul>
        <p><strong>Recommandations:</strong></p>
        <ul>
          <li>${benefice > 0 ? `Continuez Ã  maximiser la disponibilitÃ© de ${bestCar ? DOMPurify.sanitize(bestCar.nom) : "vos meilleures unitÃ©s"}.` : "RÃ©duisez les dÃ©penses ou augmentez les prix des vÃ©hicules peu rentables."}</li>
          <li>Priorisez le traitement des ${pendingCount} demandes de rÃ©servation en attente.</li>
          <li>Envisagez dâ€™ajouter des modÃ¨les similaires Ã  ${bestCar ? DOMPurify.sanitize(bestCar.nom) : "vos unitÃ©s performantes"}.</li>
          <li>VÃ©rifiez les vidanges pour ${highMileageCars} voitures Ã  fort kilomÃ©trage.</li>
        </ul>
      `;
      iaAnalysis.innerHTML = analysisText;
    }

    // Load agency data
    async function loadAgencyData(user) {
      loader.style.display = "block";
      try {
        const resQuery = query(collection(db, "reservations"), where("agencyId", "==", user.uid));
        const resSnapshot = await getDocs(resQuery);
        await Promise.all([loadReservations(user), loadFleet(user, resSnapshot)]);
        loader.style.display = "none";
        Toastify({ text: "DonnÃ©es chargÃ©es avec succÃ¨s ðŸ“Š", duration: 3000, backgroundColor: "#4ade80" }).showToast();
      } catch (err) {
        Toastify({ text: `Erreur: ${err.message}`, duration: 3000, backgroundColor: "#ef4444" }).showToast();
        loader.style.display = "none";
      }
    }

    // Modal handling
    document.getElementById("addCarBtn").addEventListener("click", () => {
      document.getElementById("addCarModal").style.display = "flex";
    });
    document.getElementById("closeModalBtn").addEventListener("click", () => {
      document.getElementById("addCarModal").style.display = "none";
    });
    document.getElementById("addCarForm").addEventListener("submit", addCar);

    // Attach filter listeners once
    document.getElementById("resFilter").addEventListener("input", filterReservations);
    document.getElementById("resStatusFilter").addEventListener("change", filterReservations);
    document.getElementById("fleetFilter").addEventListener("input", filterFleet);
    document.getElementById("statusFilter").addEventListener("change", filterFleet);

    // Attach logout listener once
    const logoutBtn = authSection.querySelector("#btn-logout");
    logoutBtn.addEventListener("click", () => {
      if (unsubscribeReservations) unsubscribeReservations();
      if (unsubscribeFleet) unsubscribeFleet();
      signOut(auth).then(() => {
        Toastify({ text: "DÃ©connexion rÃ©ussie.", duration: 3000, backgroundColor: "#4ade80" }).showToast();
        window.location.href = "index.html";
      }).catch(err => {
        Toastify({ text: `Erreur dÃ©connexion: ${err.message}`, duration: 3000, backgroundColor: "#ef4444" }).showToast();
      });
    });

    // Authentication state
    onAuthStateChanged(auth, async user => {
      if (!user) {
        if (unsubscribeReservations) unsubscribeReservations();
        if (unsubscribeFleet) unsubscribeFleet();
        window.location.href = "connexion.html";
        return;
      }
      updateAuthUI(user);
      const isAdminUser = await isAdmin(user);
      if (isAdminUser) {
        if (unsubscribeReservations) unsubscribeReservations();
        if (unsubscribeFleet) unsubscribeFleet();
        Toastify({ text: "Redirection vers le tableau de bord admin.", duration: 3000, backgroundColor: "#3b82f6" }).showToast();
        window.location.href = "admin-dashboard.html";
        return;
      }
      const aboDoc = await getDoc(doc(db, "abonnements", user.uid));
      if (!aboDoc.exists() || !aboDoc.data().pack) {
        if (unsubscribeReservations) unsubscribeReservations();
        if (unsubscribeFleet) unsubscribeFleet();
        Toastify({ text: "AccÃ¨s refusÃ©. Abonnement premium requis.", duration: 3000, backgroundColor: "#ef4444" }).showToast();
        window.location.href = "index.html";
        return;
      }
      loadAgencyData(user);
    });

    // Offline support
    window.addEventListener("offline", () => {
      Toastify({ text: "Vous Ãªtes hors ligne.", duration: -1, backgroundColor: "#ef4444" }).showToast();
    });
    window.addEventListener("online", () => {
      Toastify({ text: "Connexion rÃ©tablie.", duration: 3000, backgroundColor: "#4ade80" }).showToast();
      if (auth.currentUser) loadAgencyData(auth.currentUser);
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</body>
</html>
