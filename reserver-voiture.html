<!-- ... (header + style similaires) -->
<body>
  <div class="topbar">
    <span id="user-email"></span>
    <button id="logoutBtn">Se déconnecter</button>
  </div>

  <div class="form-container">
    <h2>Réserver</h2>
    <div id="carDetails">Chargement...</div>
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <button id="reserveBtn" onclick="submitReservation()">Réserver maintenant</button>
  </div>

  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const urlParams = new URLSearchParams(window.location.search);
    const carId = urlParams.get("carId");

    let user;
    let carData;

    auth.onAuthStateChanged(u => {
      if (!u) return location.href = "connexion.html";
      user = u;
      document.getElementById("user-email").textContent = "Connecté : " + user.email;
      loadCar();
    });

    document.getElementById("logoutBtn").onclick = () => {
      auth.signOut().then(() => location.href = "index.html");
    };

    function loadCar() {
      db.collection("cars").doc(carId).get().then(doc => {
        if (!doc.exists) return carDetails.textContent = "Voiture introuvable.";
        carData = doc.data();
        carDetails.innerHTML = `<strong>${carData.nom}</strong> - ${carData.prix} MAD/jour`;
      });
    }

    async function submitReservation() {
      const reserveBtn = document.getElementById("reserveBtn");
      reserveBtn.disabled = true;

      const start = new Date(document.getElementById("startDate").value);
      const end = new Date(document.getElementById("endDate").value);

      if (!start || !end || end <= start) {
        Toastify({ text: "Dates invalides.", backgroundColor: "#ef4444", duration: 3000 }).showToast();
        reserveBtn.disabled = false;
        return;
      }

      try {
        const existing = await db.collection("reservations")
          .where("carId", "==", carId)
          .where("status", "==", "confirmed")
          .get();

        for (let doc of existing.docs) {
          const r = doc.data();
          const rs = r.startDate.toDate(), re = r.endDate.toDate();
          if ((start <= re && end >= rs)) {
            Toastify({ text: "Déjà réservé à ces dates.", backgroundColor: "#ef4444", duration: 3000 }).showToast();
            reserveBtn.disabled = false;
            return;
          }
        }

        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        const total = days * carData.prix;

        await db.collection("reservations").add({
          carId, userId: user.uid,
          startDate: start, endDate: end,
          totalPrice: total, status: "pending",
          createdAt: new Date()
        });

        location.href = "confirmation.html";

      } catch (e) {
        Toastify({ text: "Erreur : " + e.message, backgroundColor: "#ef4444", duration: 3000 }).showToast();
      }

      reserveBtn.disabled = false;
    }
  </script>
</body>
</html>
