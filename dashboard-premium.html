<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Tableau de bord AutoRent pour g√©rer votre flotte automobile, suivre vos r√©servations, analyser vos performances et g√©rer votre profil d'agence." />
  <meta name="robots" content="index, follow" />
  <title>AutoRent - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.9.3/dist/html2pdf.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js"></script>
  <script type="module" src="js/firebase.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, startAfter, updateDoc, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js';

    const firebaseConfig = {
      // Replace with your Firebase config
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let lastVisible = null;
    let currentUser = null;
    let agencyName = '';
    let agencyLogo = '';

    // Firestore Security Rules (Reference for implementation)
    /*
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /agencies/{agencyId} {
          allow read, write: if request.auth != null && request.auth.uid == agencyId;
        }
        match /cars/{carId} {
          allow read, write: if request.auth != null && resource.data.agencyId == request.auth.uid;
        }
        match /reviews/{reviewId} {
          allow read: if true;
          allow write: if request.auth != null && resource.data.agencyId == request.auth.uid;
        }
        match /reservations/{reservationId} {
          allow read, write: if request.auth != null && resource.data.agencyId == request.auth.uid;
        }
        match /payments/{paymentId} {
          allow read, write: if request.auth != null && resource.data.agencyId == request.auth.uid;
        }
      }
    }
    */

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('user-name').textContent = user.displayName || user.email;
        loadAgencyProfile();
        loadCars();
        loadReservations();
        loadRevenueChart();
        loadCarComparison();
        loadCalendar();
        loadIAInsights();
        loadHistoricalStats();
      } else {
        window.location.href = 'login.html';
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      signOut(auth).then(() => window.location.href = 'login.html');
    });

    // Agency Profile
    async function loadAgencyProfile() {
      const agencySection = document.getElementById('agencyReviews');
      agencySection.innerHTML = '<div id="loading">Chargement du profil...</div>';
      const q = query(collection(db, 'agencies'), where('agencyId', '==', currentUser.uid));
      const snapshot = await getDocs(q);
      snapshot.forEach(doc => {
        const data = doc.data();
        agencyName = data.name || 'Agence';
        agencyLogo = data.logo || '';
        document.getElementById('agencyName').value = agencyName;
        document.getElementById('rcNumber').value = data.rcNumber || '';
        if (agencyLogo) {
          document.getElementById('agencyLogoPreview').src = agencyLogo;
          document.getElementById('headerAgencyLogo').src = agencyLogo;
          document.getElementById('headerAgencyLogo').style.display = 'block';
        }
        document.getElementById('welcomeMessage').textContent = `Bienvenue, ${agencyName} !`;
      });
      loadAgencyReviews();
    }

    document.getElementById('agencyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('agencyName').value;
      const rcNumber = document.getElementById('rcNumber').value;
      const logoFile = document.getElementById('agencyLogo').files[0];
      let logoUrl = document.getElementById('agencyLogoPreview').src;

      if (logoFile) {
        const storageRef = ref(storage, `agencies/${currentUser.uid}/logo`);
        await uploadBytes(storageRef, logoFile);
        logoUrl = await getDownloadURL(storageRef);
      }

      await addDoc(collection(db, 'agencies'), {
        agencyId: currentUser.uid,
        name,
        rcNumber,
        logo: logoUrl,
        updatedAt: new Date()
      });
      agencyName = name;
      agencyLogo = logoUrl;
      document.getElementById('headerAgencyLogo').src = logoUrl;
      document.getElementById('headerAgencyLogo').style.display = 'block';
      document.getElementById('welcomeMessage').textContent = `Bienvenue, ${agencyName} !`;
      Toastify({ text: 'Profil mis √† jour !', backgroundColor: '#4ade80' }).showToast();
    });

    // Agency Reviews with Pagination and Filters
    async function loadAgencyReviews(pageSize = 5) {
      const reviewList = document.getElementById('agencyReviewList');
      reviewList.innerHTML = '<div id="loading">Chargement des avis...</div>';
      let q = query(
        collection(db, 'reviews'),
        where('agencyId', '==', currentUser.uid),
        orderBy(document.getElementById('reviewSort').value || 'createdAt', 'desc'),
        limit(pageSize)
      );
      const ratingFilter = document.getElementById('reviewRatingFilter').value;
      if (ratingFilter) q = query(q, where('rating', '==', parseInt(ratingFilter)));
      if (lastVisible) q = query(q, startAfter(lastVisible));
      const snapshot = await getDocs(q);
      reviewList.innerHTML = '';
      snapshot.forEach(doc => {
        const review = doc.data();
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `<div class="review-info"><h3>${review.userName}</h3><p class="rating">${'‚òÖ'.repeat(review.rating)}</p><p>${review.comment}</p></div>`;
        reviewList.appendChild(div);
      });
      lastVisible = snapshot.docs[snapshot.docs.length - 1];
      updateReviewPagination(snapshot.size < pageSize);
    }

    function updateReviewPagination(isLastPage) {
      const pagination = document.getElementById('reviewPagination');
      pagination.innerHTML = '';
      if (!isLastPage) {
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.textContent = 'Charger plus';
        loadMoreBtn.addEventListener('click', () => loadAgencyReviews());
        pagination.appendChild(loadMoreBtn);
      }
    }

    document.getElementById('reviewSort').addEventListener('change', () => loadAgencyReviews());
    document.getElementById('reviewRatingFilter').addEventListener('change', () => loadAgencyReviews());

    // Car Reviews
    async function loadCarReviews(carId) {
      const reviewList = document.getElementById('carReviewList');
      reviewList.innerHTML = '<div id="loading">Chargement des avis...</div>';
      let q = query(
        collection(db, 'reviews'),
        where('carId', '==', carId),
        where('agencyId', '==', currentUser.uid),
        orderBy(document.getElementById('carReviewSort').value || 'createdAt', 'desc'),
        limit(5)
      );
      const ratingFilter = document.getElementById('carReviewRatingFilter').value;
      if (ratingFilter) q = query(q, where('rating', '==', parseInt(ratingFilter)));
      const snapshot = await getDocs(q);
      reviewList.innerHTML = '';
      snapshot.forEach(doc => {
        const review = doc.data();
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `<div class="review-info"><h3>${review.userName}</h3><p class="rating">${'‚òÖ'.repeat(review.rating)}</p><p>${review.comment}</p></div>`;
        reviewList.appendChild(div);
      });
    }

    document.getElementById('carReviewSelect').addEventListener('change', (e) => {
      if (e.target.value) loadCarReviews(e.target.value);
    });
    document.getElementById('carReviewSort').addEventListener('change', () => {
      const carId = document.getElementById('carReviewSelect').value;
      if (carId) loadCarReviews(carId);
    });
    document.getElementById('carReviewRatingFilter').addEventListener('change', () => {
      const carId = document.getElementById('carReviewSelect').value;
      if (carId) loadCarReviews(carId);
    });

    // Car Management with Filters
    async function loadCars() {
      const carList = document.getElementById('carList');
      const carReviewSelect = document.getElementById('carReviewSelect');
      const comparisonCar1 = document.getElementById('comparisonCar1');
      const comparisonCar2 = document.getElementById('comparisonCar2');
      carList.innerHTML = '<div id="loading">Chargement des voitures...</div>';
      let q = query(
        collection(db, 'cars'),
        where('agencyId', '==', currentUser.uid),
        orderBy(document.getElementById('carSort').value || 'name', 'asc')
      );
      const typeFilter = document.getElementById('carTypeFilter').value;
      if (typeFilter) q = query(q, where('type', '==', typeFilter));
      const snapshot = await getDocs(q);
      carList.innerHTML = '';
      carReviewSelect.innerHTML = '<option value="">S√©lectionner une voiture</option>';
      comparisonCar1.innerHTML = '<option value="">S√©lectionner la premi√®re voiture</option>';
      comparisonCar2.innerHTML = '<option value="">S√©lectionner la deuxi√®me voiture</option>';
      snapshot.forEach(doc => {
        const car = doc.data();
        const div = document.createElement('div');
        div.className = 'car-item';
        div.innerHTML = `
          <img src="${car.image}" alt="${car.name}" />
          <div class="car-info">
            <h3>${car.name}</h3>
            <p>${car.type} | ${car.location} | ${car.transmission}</p>
            <p>Prix: ${car.price} MAD/jour</p>
            <p>${car.available ? 'Disponible' : 'Indisponible'}</p>
            <button class="edit-btn" data-id="${doc.id}">Modifier</button>
            <button class="delete-btn" data-id="${doc.id}">Supprimer</button>
          </div>`;
        carList.appendChild(div);
        carReviewSelect.innerHTML += `<option value="${doc.id}">${car.name}</option>`;
        comparisonCar1.innerHTML += `<option value="${doc.id}">${car.name}</option>`;
        comparisonCar2.innerHTML += `<option value="${doc.id}">${car.name}</option>`;
      });
      document.getElementById('carTotal').textContent = snapshot.size;
    }

    document.getElementById('carSort').addEventListener('change', loadCars);
    document.getElementById('carTypeFilter').addEventListener('change', loadCars);

    // AI Description Generation
    document.getElementById('generateDesc').addEventListener('click', async () => {
      const name = document.getElementById('name').value;
      const type = document.getElementById('type').value;
      const response = await fetch('https://api.x.ai/grok', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt: `G√©n√®re une description professionnelle pour une voiture de location : ${name}, type : ${type}.`
        })
      });
      const data = await response.json();
      document.getElementById('desc').value = data.description || 'Description g√©n√©r√©e par IA.';
    });

    // Calendar Configuration
    async function loadCalendar() {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        editable: true,
        events: async (fetchInfo, successCallback) => {
          const q = query(collection(db, 'reservations'), where('agencyId', '==', currentUser.uid));
          const snapshot = await getDocs(q);
          const events = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
              id: doc.id,
              title: data.type === 'maintenance' ? 'Maintenance' : `R√©servation: ${data.carName}`,
              start: data.startDate,
              end: data.endDate,
              backgroundColor: data.type === 'maintenance' ? '#ef4444' : data.status === 'accepted' ? '#4ade80' : '#facc15',
              extendedProps: { type: data.type, status: data.status }
            };
          });
          successCallback(events);
        },
        eventDrop: async (info) => {
          await updateDoc(doc(db, 'reservations', info.event.id), {
            startDate: info.event.start,
            endDate: info.event.end
          });
          Toastify({ text: 'R√©servation mise √† jour !', backgroundColor: '#4ade80' }).showToast();
        },
        eventClick: async (info) => {
          if (confirm('Voulez-vous supprimer cette r√©servation ?')) {
            await deleteDoc(doc(db, 'reservations', info.event.id));
            info.event.remove();
            Toastify({ text: 'R√©servation supprim√©e !', backgroundColor: '#4ade80' }).showToast();
          }
        }
      });
      calendar.render();
    }

    // Revenue Chart
    async function loadRevenueChart() {
      const period = document.getElementById('revenuePeriod').value;
      const q = query(collection(db, 'reservations'), where('agencyId', '==', currentUser.uid), where('status', '==', 'accepted'));
      const snapshot = await getDocs(q);
      const data = {};
      snapshot.forEach(doc => {
        const res = doc.data();
        const date = new Date(res.startDate);
        const key = period === 'month' ? date.getMonth() : period === 'quarter' ? Math.floor(date.getMonth() / 3) : date.getFullYear();
        data[key] = (data[key] || 0) + res.totalPrice;
      });

      const ctx = document.getElementById('performanceChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(data).map(k => period === 'month' ? `Mois ${k}` : period === 'quarter' ? `Trimestre ${k}` : `Ann√©e ${k}`),
          datasets: [{
            label: 'Revenus (MAD)',
            data: Object.values(data),
            backgroundColor: '#38bdf8'
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    document.getElementById('revenuePeriod').addEventListener('change', loadRevenueChart);

    // Historical Statistics
    async function loadHistoricalStats() {
      const ctx = document.getElementById('historicalChart').getContext('2d');
      const q = query(collection(db, 'reservations'), where('agencyId', '==', currentUser.uid), where('status', '==', 'accepted'));
      const snapshot = await getDocs(q);
      const revenueData = {};
      const bookingData = {};
      snapshot.forEach(doc => {
        const res = doc.data();
        const date = new Date(res.startDate);
        const month = `${date.getFullYear()}-${date.getMonth() + 1}`;
        revenueData[month] = (revenueData[month] || 0) + res.totalPrice;
        bookingData[month] = (bookingData[month] || 0) + 1;
      });

      const labels = Object.keys(revenueData).sort();
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Revenus (MAD)',
              data: labels.map(month => revenueData[month] || 0),
              borderColor: '#38bdf8',
              fill: false
            },
            {
              label: 'R√©servations',
              data: labels.map(month => bookingData[month] || 0),
              borderColor: '#4ade80',
              fill: false
            }
          ]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Payment Status Check for Premium Features
    async function checkPaymentStatus() {
      const q = query(collection(db, 'payments'), where('agencyId', '==', currentUser.uid), where('status', '==', 'paid'), where('type', '==', 'premium'));
      const snapshot = await getDocs(q);
      const now = new Date();
      return snapshot.docs.some(doc => {
        const data = doc.data();
        const expiry = new Date(data.expiryDate);
        return expiry > now;
      });
    }

    // PDF Export with Premium Check
    document.getElementById('exportPerformance').addEventListener('click', async () => {
      if (!await checkPaymentStatus()) {
        Toastify({ text: 'Abonnement premium requis pour exporter. Visitez https://x.ai/grok pour plus d‚Äôinfos.', backgroundColor: '#ef4444' }).showToast();
        return;
      }
      const element = document.createElement('div');
      element.innerHTML = `
        <h1>AutoRent - Rapport de Performance</h1>
        <h2>${agencyName}</h2>
        <p>P√©riode: ${document.getElementById('revenuePeriod').value}</p>
        <img src="${agencyLogo}" style="max-width: 100px;" />
        <canvas id="pdfChart" width="400" height="200"></canvas>
        <p>${document.getElementById('iaAnalysis').innerHTML}</p>
      `;
      document.body.appendChild(element);
      const canvas = document.getElementById('performanceChart');
      const pdfCanvas = element.querySelector('#pdfChart');
      pdfCanvas.getContext('2d').drawImage(canvas, 0, 0, 400, 200);
      await html2pdf().from(element).set({ filename: 'AutoRent_Performance.pdf' }).save();
      document.body.removeChild(element);
    });

    // Car Comparison with Premium Check
    async function loadCarComparison() {
      if (!await checkPaymentStatus()) {
        document.getElementById('comparisonTable').style.display = 'none';
        document.getElementById('noComparison').textContent = 'Abonnement premium requis pour comparer. Visitez https://x.ai/grok pour plus d‚Äôinfos.';
        return;
      }
      const car1 = document.getElementById('comparisonCar1').value;
      const car2 = document.getElementById('comparisonCar2').value;
      if (!car1 || !car2) {
        document.getElementById('comparisonTable').style.display = 'none';
        document.getElementById('noComparison').textContent = 'Aucune comparaison disponible. S√©lectionnez deux voitures.';
        return;
      }
      document.getElementById('comparisonTable').style.display = 'table';
      document.getElementById('noComparison').style.display = 'none';
      const [car1Data, car2Data] = await Promise.all([
        getDocs(query(collection(db, 'reservations'), where('carId', '==', car1), where('agencyId', '==', currentUser.uid))),
        getDocs(query(collection(db, 'reservations'), where('carId', '==', car2), where('agencyId', '==', currentUser.uid)))
      ]);

      const calculateMetrics = (snapshot) => {
        let revenue = 0, daysRented = 0, accepted = 0, totalRequests = snapshot.size;
        snapshot.forEach(doc => {
          const data = doc.data();
          revenue += data.totalPrice;
          daysRented += (new Date(data.endDate) - new Date(data.startDate)) / (1000 * 60 * 60 * 24);
          if (data.status === 'accepted') accepted++;
        });
        const totalDays = 30; // Example period
        return {
          revenue,
          availability: (daysRented / totalDays * 100).toFixed(2),
          acceptance: totalRequests ? (accepted / totalRequests * 100).toFixed(2) : 0
        };
      };

      const metrics1 = calculateMetrics(car1Data);
      const metrics2 = calculateMetrics(car2Data);
      document.getElementById('compRevenue1').textContent = `${metrics1.revenue} MAD`;
      document.getElementById('compRevenue2').textContent = `${metrics2.revenue} MAD`;
      document.getElementById('compAvailability1').textContent = `${metrics1.availability}%`;
      document.getElementById('compAvailability2').textContent = `${metrics2.availability}%`;
      document.getElementById('compAcceptance1').textContent = `${metrics1.acceptance}%`;
      document.getElementById('compAcceptance2').textContent = `${metrics2.acceptance}%`;
    }

    document.getElementById('comparisonCar1').addEventListener('change', loadCarComparison);
    document.getElementById('comparisonCar2').addEventListener('change', loadCarComparison);

    // IA Insights
    async function loadIAInsights() {
      const iaAnalysis = document.getElementById('iaAnalysis');
      iaAnalysis.innerHTML = '<div id="loading">Chargement de l‚Äôanalyse...</div>';
      const q = query(collection(db, 'reservations'), where('agencyId', '==', currentUser.uid));
      const snapshot = await getDocs(q);
      const cars = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        if (!cars[data.carId]) cars[data.carId] = { revenue: 0, daysRented: 0, name: data.carName };
        cars[data.carId].revenue += data.totalPrice;
        cars[data.carId].daysRented += (new Date(data.endDate) - new Date(data.startDate)) / (1000 * 60 * 60 * 24);
      });

      const mostProfitable = Object.values(cars).reduce((a, b) => a.revenue > b.revenue ? a : b, { revenue: 0 });
      const leastOccupied = Object.values(cars).reduce((a, b) => a.daysRented < b.daysRented ? a : b, { daysRented: Infinity });
      iaAnalysis.innerHTML = `
        <ul>
          <li><strong>SUV le plus rentable :</strong> ${mostProfitable.name} (${mostProfitable.revenue} MAD)</li>
          <li><strong>Voiture la moins occup√©e :</strong> ${leastOccupied.name} (${leastOccupied.daysRented} jours)</li>
          <li><strong>Suggestion :</strong> Baissez le prix de ${leastOccupied.name} de 10% pour augmenter les r√©servations de ~15%.</li>
        </ul>
      `;
    }

    // Reservations with Filters
    async function loadReservations() {
      const reservationList = document.getElementById('reservationList');
      reservationList.innerHTML = '<div id="loading">Chargement des r√©servations...</div>';
      let q = query(
        collection(db, 'reservations'),
        where('agencyId', '==', currentUser.uid),
        orderBy(document.getElementById('reservationSort').value || 'startDate', 'desc')
      );
      const statusFilter = document.getElementById('reservationStatusFilter').value;
      if (statusFilter) q = query(q, where('status', '==', statusFilter));
      const snapshot = await getDocs(q);
      reservationList.innerHTML = '';
      snapshot.forEach(doc => {
        const res = doc.data();
        const div = document.createElement('div');
        div.className = 'reservation-item';
        div.innerHTML = `
          <div class="reservation-info">
            <h3>${res.carName}</h3>
            <p>Client: ${res.clientName}</p>
            <p>Dates: ${res.startDate} √† ${res.endDate}</p>
            <p>Statut: ${res.status}</p>
            ${res.status === 'pending' ? `
              <button class="approve-btn" data-id="${doc.id}">Approuver</button>
              <button class="reject-btn" data-id="${doc.id}">Rejeter</button>
            ` : ''}
          </div>`;
        reservationList.appendChild(div);
      });
    }

    document.getElementById('reservationSort').addEventListener('change', loadReservations);
    document.getElementById('reservationStatusFilter').addEventListener('change', loadReservations);

    // Commission Payment
    window.payerCommission = async () => {
      await addDoc(collection(db, 'payments'), {
        agencyId: currentUser.uid,
        amount: 1000, // Example
        status: 'paid',
        type: 'commission',
        date: new Date()
      });
      Toastify({ text: 'Commission pay√©e !', backgroundColor: '#4ade80' }).showToast();
    };
  </script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      background: rgba(15, 23, 42, 0.95);
      padding: 16px 32px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .header-agency {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .header-agency img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      display: none;
    }
    h1 {
      font-size: 1.8rem;
      color: #38bdf8;
      margin: 0;
    }
    .welcome-message {
      font-size: 1.2rem;
      color: #facc15;
      margin-top: 10px;
      text-align: center;
      width: 100%;
    }
    .user-info {
      text-align: right;
      font-size: 0.9rem;
    }
    .user-info span {
      color: #facc15;
      font-weight: 600;
    }
    .logout-btn {
      background-color: #ef4444;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      margin-top: 8px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }
    .logout-btn:hover, .logout-btn:focus {
      background-color: #dc2626;
      transform: scale(1.05);
    }
    .free-offer {
      background: #4ade80;
      color: #0f172a;
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      margin: 20px auto;
      max-width: 800px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    .form-section, .list-section, .chart-section, .ia-section, .agency-section, .calendar-section, .comparison-section, .historical-section {
      background: #1e293b;
      padding: 25px;
      border-radius: 12px;
      max-width: 900px;
      margin: 20px auto;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      position: relative;
    }
    .form-section h2, .list-section h2, .chart-section h2, .ia-section h2, .agency-section h2, .calendar-section h2, .comparison-section h2, .historical-section h2 {
      margin-bottom: 20px;
      color: #4ade80;
      font-size: 1.5rem;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #facc15;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      background: #334155;
      color: #fff;
      transition: background 0.3s;
    }
    input:focus, textarea:focus, select:focus {
      background: #475569;
      outline: 2px solid #38bdf8;
    }
    .filter-group {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    .preview-image {
      max-width: 200px;
      margin-bottom: 15px;
      border-radius: 8px;
      display: none;
      object-fit: cover;
    }
    .available-switch {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .available-switch input {
      margin-right: 10px;
    }
    .btn, .generate-btn {
      background: #38bdf8;
      color: #0f172a;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s, transform 0.2s;
    }
    .btn:hover, .btn:focus, .generate-btn:hover, .generate-btn:focus {
      background: #0ea5e9;
      transform: scale(1.05);
    }
    .navigation {
      text-align: center;
      margin: 40px 0;
    }
    .navigation a {
      color: #facc15;
      text-decoration: none;
      font-weight: bold;
      margin: 0 10px;
      transition: color 0.3s;
    }
    .navigation a:hover, .navigation a:focus {
      color: #38bdf8;
    }
    .car-list, .reservation-list, .review-list {
      margin-top: 20px;
    }
    .car-item, .reservation-item, .review-item {
      background: #334155;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      display: flex;
      gap: 20px;
      align-items: center;
      transition: transform 0.3s;
    }
    .car-item:hover, .reservation-item:hover, .review-item:hover {
      transform: translateY(-5px);
    }
    .car-item img, .agency-logo {
      width: 100px;
      border-radius: 10px;
      object-fit: cover;
    }
    .car-info, .reservation-info, .review-info, .agency-info {
      flex: 1;
    }
    .car-info h3, .reservation-info h3, .review-info h3, .agency-info h3 {
      margin: 0;
      color: #facc15;
      font-size: 1.2rem;
    }
    .car-info p, .reservation-info p, .review-info p, .agency-info p {
      margin: 5px 0;
      font-size: 0.9rem;
    }
    .reserve-btn, .edit-btn, .delete-btn, .approve-btn, .reject-btn, .export-btn {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-left: 10px;
      transition: background 0.3s, transform 0.2s;
    }
    .reserve-btn, .export-btn {
      background: #4ade80;
      color: #0f172a;
    }
    .reserve-btn:hover, .reserve-btn:focus, .export-btn:hover, .export-btn:focus {
      background: #22c55e;
      transform: scale(1.05);
    }
    .edit-btn {
      background: #facc15;
      color: #0f172a;
    }
    .edit-btn:hover, .edit-btn:focus {
      background: #e0ab0d;
      transform: scale(1.05);
    }
    .delete-btn {
      background: #ef4444;
      color: white;
    }
    .delete-btn:hover, .delete-btn:focus {
      background: #dc2626;
      transform: scale(1.05);
    }
    .approve-btn {
      background: #4ade80;
      color: #0f172a;
    }
    .approve-btn:hover, .approve-btn:focus {
      background: #22c55e;
      transform: scale(1.05);
    }
    .reject-btn {
      background: #ef4444;
      color: white;
    }
    .reject-btn:hover, .reject-btn:focus {
      background: #dc2626;
      transform: scale(1.05);
    }
    .chart-section canvas, .historical-section canvas {
      max-height: 400px;
    }
    .ia-section ul, .comparison-section ul {
      list-style: none;
      padding: 0;
    }
    .ia-section li, .comparison-section li {
      margin: 10px 0;
      font-size: 0.9rem;
    }
    .ia-section strong, .comparison-section strong {
      color: #facc15;
    }
    #loading {
      text-align: center;
      margin: 20px 0;
      font-size: 1rem;
      color: #facc15;
      display: none;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .pagination button {
      background: #38bdf8;
      color: #0f172a;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .pagination button:disabled {
      background: #475569;
      cursor: not-allowed;
    }
    .fc-daygrid-day-number {
      color: #fff !important;
    }
    .fc-daygrid-day {
      background: #334155 !important;
    }
    .fc-daygrid-day:hover {
      background: #475569 !important;
    }
    .fc-event {
      background: #facc15 !important;
      border: none !important;
      color: #0f172a !important;
      font-size: 0.8rem !important;
    }
    .fc-event.maintenance {
      background: #ef4444 !important;
    }
    .fc-event.accepted {
      background: #4ade80 !important;
    }
    .rating {
      color: #facc15;
      font-size: 0.9rem;
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      display: none;
    }
    .comparison-table th, .comparison-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #475569;
    }
    .comparison-table th {
      background: #38bdf8;
      color: #0f172a;
    }
    .no-comparison {
      text-align: center;
      color: #facc15;
      font-size: 1rem;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-section, .list-section, .chart-section, .ia-section, .agency-section, .calendar-section, .comparison-section, .historical-section {
      animation: fadeIn 0.5s ease-out;
    }
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        text-align: center;
      }
      .header-agency {
        justify-content: center;
      }
      .user-info {
        margin-top: 10px;
      }
      .car-item, .reservation-item, .review-item {
        flex-direction: column;
        text-align: center;
      }
      .car-item img, .agency-logo {
        width: 100%;
        max-width: 200px;
      }
      .comparison-table {
        font-size: 0.8rem;
      }
      .filter-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-agency">
      <img id="headerAgencyLogo" class="agency-logo" alt="Logo de l'agence" />
      <h1>üéØ Dashboard - AutoRent</h1>
    </div>
    <div class="user-info">
      <p>Connect√© en tant que : <span id="user-name"></span></p>
      <button class="logout-btn" id="logoutBtn" aria-label="Se d√©connecter">Se d√©connecter</button>
    </div>
  </header>
  <div class="welcome-message" id="welcomeMessage">Bienvenue !</div>

  <div class="free-offer">
    <p>üéâ AutoRent est <strong>100% GRATUIT</strong> pour le lancement !</p>
  </div>

  <div class="agency-section">
    <h2>üè¢ Profil de l'Agence</h2>
    <div id="loading">Chargement...</div>
    <form id="agencyForm">
      <label for="agencyName">Nom de l'Agence</label>
      <input type="text" id="agencyName" placeholder="ex: AutoRent Casablanca" required aria-label="Nom de l'agence" />
      <label for="agencyLogo">Logo de l'Agence</label>
      <input type="file" id="agencyLogo" accept="image/jpeg,image/png,image/webp" aria-label="Logo de l'agence" />
      <img id="agencyLogoPreview" class="agency-logo preview-image" alt="Pr√©visualisation du logo" />
      <label for="rcNumber">Num√©ro RC</label>
      <input type="text" id="rcNumber" placeholder="ex: RC123456" required aria-label="Num√©ro RC" />
      <button type="submit" class="btn" aria-label="Mettre √† jour le profil">Mettre √† jour le profil</button>
    </form>
    <div class="review-list" id="agencyReviews">
      <h3>Avis Clients</h3>
      <div id="loading">Chargement...</div>
      <div class="filter-group">
        <select id="reviewSort" aria-label="Trier les avis">
          <option value="createdAt">Trier par date</option>
          <option value="rating">Trier par note</option>
        </select>
        <select id="reviewRatingFilter" aria-label="Filtrer par note">
          <option value="">Toutes les notes</option>
          <option value="5">5 √©toiles</option>
          <option value="4">4 √©toiles</option>
          <option value="3">3 √©toiles</option>
          <option value="2">2 √©toiles</option>
          <option value="1">1 √©toile</option>
        </select>
      </div>
      <div id="agencyReviewList"></div>
      <div class="pagination" id="reviewPagination"></div>
    </div>
  </div>

  <div class="form-section">
    <h2>‚ûï Ajouter une nouvelle voiture</h2>
    <div id="loading">Chargement...</div>
    <form id="carForm">
      <label for="name">Nom de la voiture</label>
      <input type="text" id="name" placeholder="ex: Dacia Logan 2022" required aria-label="Nom de la voiture" />
      <label for="image">Image de la voiture</label>
      <input type="file" id="image" accept="image/jpeg,image/png,image/webp" required aria-label="Image de la voiture" />
      <img id="previewImage" class="preview-image" alt="Pr√©visualisation de l'image" />
      <label for="price">Prix par jour (en MAD)</label>
      <input type="number" id="price" placeholder="ex: 250" required min="0" step="0.01" aria-label="Prix par jour" />
      <label for="desc">Description</label>
      <textarea id="desc" rows="4" placeholder="Description auto ou g√©n√©r√©e..." aria-label="Description de la voiture"></textarea>
      <button type="button" class="generate-btn" id="generateDesc" aria-label="G√©n√©rer description IA">G√©n√©rer description IA</button>
      <label for="type">Type</label>
      <select id="type" required aria-label="Type de voiture">
        <option value="berline">Berline</option>
        <option value="SUV">SUV</option>
        <option value="citadine">Citadine</option>
        <option value="utilitaire">Utilitaire</option>
      </select>
      <label for="location">Ville</label>
      <input type="text" id="location" placeholder="ex: Casablanca" required aria-label="Ville de disponibilit√©" />
      <label for="transmission">Transmission</label>
      <select id="transmission" required aria-label="Type de transmission">
        <option value="manuelle">Manuelle</option>
        <option value="automatique">Automatique</option>
      </select>
      <div class="available-switch">
        <input type="checkbox" id="available" checked aria-label="Voiture disponible" />
        <label for="available">Disponible</label>
      </div>
      <button type="submit" class="btn" aria-label="Ajouter la voiture">Ajouter la voiture</button>
    </form>
  </div>

  <div class="list-section">
    <h2>üöó Mes voitures publi√©es</h2>
    <div id="loading">Chargement...</div>
    <div class="filter-group">
      <select id="carSort" aria-label="Trier les voitures">
        <option value="name">Trier par nom</option>
        <option value="price">Trier par prix</option>
        <option value="type">Trier par type</option>
      </select>
      <select id="carTypeFilter" aria-label="Filtrer par type">
        <option value="">Tous les types</option>
        <option value="berline">Berline</option>
        <option value="SUV">SUV</option>
        <option value="citadine">Citadine</option>
        <option value="utilitaire">Utilitaire</option>
      </select>
    </div>
    <div class="car-list" id="carList"></div>
    <div class="pagination" id="carPagination"></div>
    <div class="review-list" id="carReviews">
      <h3>Avis par voiture</h3>
      <div id="loading">Chargement...</div>
      <div class="filter-group">
        <select id="carReviewSelect" aria-label="S√©lectionner une voiture pour les avis">
          <option value="">S√©lectionner une voiture</option>
        </select>
        <select id="carReviewSort" aria-label="Trier les avis">
          <option value="createdAt">Trier par date</option>
          <option value="rating">Trier par note</option>
        </select>
        <select id="carReviewRatingFilter" aria-label="Filtrer par note">
          <option value="">Toutes les notes</option>
          <option value="5">5 √©toiles</option>
          <option value="4">4 √©toiles</option>
          <option value="3">3 √©toiles</option>
          <option value="2">2 √©toiles</option>
          <option value="1">1 √©toile</option>
        </select>
      </div>
      <div id="carReviewList"></div>
    </div>
  </div>

  <div class="calendar-section">
    <h2>üìÖ Planning de disponibilit√©</h2>
    <div id="loading">Chargement...</div>
    <div id="calendar"></div>
  </div>

  <div class="chart-section">
    <h2>üìä Performances de la flotte</h2>
    <div id="loading">Chargement...</div>
    <select id="revenuePeriod" aria-label="P√©riode d'analyse des revenus">
      <option value="month">Mois</option>
      <option value="quarter">Trimestre</option>
      <option value="year">Ann√©e</option>
    </select>
    <canvas id="performanceChart"></canvas>
    <button class="export-btn" id="exportPerformance" aria-label="Exporter en PDF">Exporter en PDF</button>
  </div>

  <div class="historical-section">
    <h2>üìà Historique des performances</h2>
    <div id="loading">Chargement...</div>
    <canvas id="historicalChart"></canvas>
  </div>

  <div class="list-section">
    <h2>üì• R√©servations</h2>
    <div id="loading">Chargement...</div>
    <div class="filter-group">
      <select id="reservationSort" aria-label="Trier les r√©servations">
        <option value="startDate">Trier par date de d√©but</option>
        <option value="carName">Trier par nom de voiture</option>
        <option value="status">Trier par statut</option>
      </select>
      <select id="reservationStatusFilter" aria-label="Filtrer par statut">
        <option value="">Tous les statuts</option>
        <option value="pending">En attente</option>
        <option value="accepted">Accept√©e</option>
        <option value="rejected">Rejet√©e</option>
      </select>
    </div>
    <div class="reservation-list" id="reservationList"></div>
  </div>

  <div class="comparison-section">
    <h2>‚öñÔ∏è Comparaison des voitures</h2>
    <div id="loading">Chargement...</div>
    <select id="comparisonCar1" aria-label="S√©lectionner la premi√®re voiture">
      <option value="">S√©lectionner la premi√®re voiture</option>
    </select>
    <select id="comparisonCar2" aria-label="S√©lectionner la deuxi√®me voiture">
      <option value="">S√©lectionner la deuxi√®me voiture</option>
    </select>
    <p class="no-comparison" id="noComparison">Aucune comparaison disponible. S√©lectionnez deux voitures.</p>
    <table class="comparison-table" id="comparisonTable">
      <thead>
        <tr>
          <th>M√©trique</th>
          <th>Voiture 1</th>
          <th>Voiture 2</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Rentabilit√© (MAD)</td>
          <td id="compRevenue1">-</td>
          <td id="compRevenue2">-</td>
        </tr>
        <tr>
          <td>Disponibilit√© (%)</td>
          <td id="compAvailability1">-</td>
          <td id="compAvailability2">-</td>
        </tr>
        <tr>
          <td>Taux d'acceptation (%)</td>
          <td id="compAcceptance1">-</td>
          <td id="compAcceptance2">-</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="list-section" style="background: #172032;">
    <h2>üí∞ Paiement des commissions</h2>
    <div id="loading">Chargement...</div>
    <p>Solde √† payer : <strong id="soldeCommission">Chargement...</strong></p>
    <button class="btn" onclick="payerCommission()" aria-label="Payer la commission">Payer maintenant</button>
  </div>

  <div class="ia-section">
    <h2>ü§ñ Analyse IA des performances</h2>
    <div id="loading">Chargement...</div>
    <div id="iaAnalysis">Chargement de l‚Äôanalyse...</div>
  </div>

  <div class="navigation">
    <p id="carCount">Vous avez <span id="carTotal">0</span> voitures publi√©es.</p>
    <p>üìä G√©rer l‚Äô√©tat de vos voitures : <a href="gerance-premium.html">G√©rance Premium</a></p>
    <p style="margin-top: 10px;">üßë‚Äçüíª Voir votre site vitrine : <a href="site-agent.html">Mon site</a></p>
  </div>
</body>
</html>